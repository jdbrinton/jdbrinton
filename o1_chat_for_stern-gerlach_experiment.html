
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>SpinorSim</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
        tailwind.config = {
        }
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <link rel="shortcut icon" href="https://chatboxai.app/icon.png">
</head>
<body class='bg-slate-100'>
    <div class='mx-auto max-w-5xl shadow-md prose bg-white px-2 py-4'>
        <h1 class='flex flex-row justify-between items-center my-4 h-8'>
            <span>SpinorSim</span>
            <a href="https://chatboxai.app" target="_blank" >
                <img src='https://chatboxai.app/icon.png' class="w-12">
            </a>
        </h1>
        <hr />
        <div class="prose-sm">
<h2>1. SpinorSim</h2>
<div class="mb-4">
<p class="text-green-500 text-lg"><b>SYSTEM: </b></p>
<div class="break-words "><p>You are a helpful assistant. You can help me by answering my questions. You can also ask me questions. I am a physicist and electrical engineer. I am also knowledgeable in mechanical engineering, software engineering, and I&#x27;m familiar with C/C++, python, javascript, Matlab, and LLMs.</p></div></div>
<div class="mb-4">
<p class="text-green-500 text-lg"><b>USER: </b></p>
<div class="break-words "><p>write a 2-D python simulation of a discrete spinor field using only pytorch, numpy and matplotlib of a single electron propagating through a stern-gerlach apparatus. Give the electron initial velocity and set the simulation parameters so that splitting is evident before the particle reaches the other end of the simulation. Periodically plot the 2-D field probability density.</p></div></div>
<div class="mb-4">
<p class="text-blue-500 text-lg"><b>ASSISTANT: </b></p>
<div class="break-words "><p>Certainly! Below is a Python code that simulates a single electron propagating through a Stern-Gerlach apparatus in 2D using <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">PyTorch</code>, <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">NumPy</code>, and <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">Matplotlib</code>. The simulation demonstrates the splitting of the electron&#x27;s wavefunction due to the interaction with a magnetic field gradient.</p>
<pre><div><div style="display:flex;justify-content:space-between;width:100%;background-color:rgb(50, 50, 50);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace;border-top-left-radius:0.3rem;border-top-right-radius:0.3rem;border-bottom-left-radius:0;border-bottom-right-radius:0"><span style="text-decoration:none;color:gray;padding:2px;margin:2px 10px 0 10px">&lt;PYTHON&gt;</span></div><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:0.3rem;border-bottom-right-radius:0.3rem;border:none"><code class="language-python" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">import</span><span> numpy </span><span class="token" style="color:#00e0e0">as</span><span> np
</span><span></span><span class="token" style="color:#00e0e0">import</span><span> matplotlib</span><span class="token" style="color:#fefefe">.</span><span>pyplot </span><span class="token" style="color:#00e0e0">as</span><span> plt
</span><span></span><span class="token" style="color:#00e0e0">import</span><span> torch</span></code></div></div></pre>
<h2>Constants and Parameters</h2>
<pre><div><div style="display:flex;justify-content:space-between;width:100%;background-color:rgb(50, 50, 50);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace;border-top-left-radius:0.3rem;border-top-right-radius:0.3rem;border-bottom-left-radius:0;border-bottom-right-radius:0"><span style="text-decoration:none;color:gray;padding:2px;margin:2px 10px 0 10px">&lt;PYTHON&gt;</span></div><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:0.3rem;border-bottom-right-radius:0.3rem;border:none"><code class="language-python" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#d4d0ab"># Physical constants</span><span>
</span><span>hbar </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">1.054571817e-34</span><span>  </span><span class="token" style="color:#d4d0ab"># Reduced Planck&#x27;s constant (J·s)</span><span>
</span><span>m_e </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">9.10938356e-31</span><span>    </span><span class="token" style="color:#d4d0ab"># Electron mass (kg)</span><span>
</span><span>mu_B </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">9.274009994e-24</span><span>  </span><span class="token" style="color:#d4d0ab"># Bohr magneton (J/T)</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Simulation parameters</span><span>
</span><span>nx</span><span class="token" style="color:#fefefe">,</span><span> ny </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">200</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">200</span><span>       </span><span class="token" style="color:#d4d0ab"># Number of spatial grid points</span><span>
</span><span>dx</span><span class="token" style="color:#fefefe">,</span><span> dy </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">1e-9</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">1e-9</span><span>     </span><span class="token" style="color:#d4d0ab"># Spatial resolution (m)</span><span>
</span><span>dt </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">1e-16</span><span>              </span><span class="token" style="color:#d4d0ab"># Time step (s)</span><span>
</span><span>nt </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">500</span><span>                </span><span class="token" style="color:#d4d0ab"># Number of time steps</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Magnetic field parameters</span><span>
</span><span>B0 </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">0.0</span><span>                </span><span class="token" style="color:#d4d0ab"># Base magnetic field (T)</span><span>
</span><span>G </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">1e7</span><span>                 </span><span class="token" style="color:#d4d0ab"># Magnetic field gradient (T/m)</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Initial electron parameters</span><span>
</span><span>x0</span><span class="token" style="color:#fefefe">,</span><span> y0 </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">50e-9</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">100e-9</span><span>  </span><span class="token" style="color:#d4d0ab"># Initial position (m)</span><span>
</span><span>sigma_x </span><span class="token" style="color:#00e0e0">=</span><span> sigma_y </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">5e-9</span><span>  </span><span class="token" style="color:#d4d0ab"># Initial wavepacket spread (m)</span><span>
</span><span>p0 </span><span class="token" style="color:#00e0e0">=</span><span> np</span><span class="token" style="color:#fefefe">.</span><span>array</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#00e0e0">1e5</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> m_e</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">0.0</span><span class="token" style="color:#fefefe">]</span><span class="token" style="color:#fefefe">)</span><span>  </span><span class="token" style="color:#d4d0ab"># Initial momentum (kg·m/s)</span></code></div></div></pre>
<h2>Spatial Grid Setup</h2>
<pre><div><div style="display:flex;justify-content:space-between;width:100%;background-color:rgb(50, 50, 50);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace;border-top-left-radius:0.3rem;border-top-right-radius:0.3rem;border-bottom-left-radius:0;border-bottom-right-radius:0"><span style="text-decoration:none;color:gray;padding:2px;margin:2px 10px 0 10px">&lt;PYTHON&gt;</span></div><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:0.3rem;border-bottom-right-radius:0.3rem;border:none"><code class="language-python" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#d4d0ab"># Create spatial grids</span><span>
</span><span>x </span><span class="token" style="color:#00e0e0">=</span><span> np</span><span class="token" style="color:#fefefe">.</span><span>linspace</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#fefefe">(</span><span>nx </span><span class="token" style="color:#00e0e0">-</span><span> </span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> dx</span><span class="token" style="color:#fefefe">,</span><span> nx</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>y </span><span class="token" style="color:#00e0e0">=</span><span> np</span><span class="token" style="color:#fefefe">.</span><span>linspace</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#fefefe">(</span><span>ny </span><span class="token" style="color:#00e0e0">-</span><span> </span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> dy</span><span class="token" style="color:#fefefe">,</span><span> ny</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>X</span><span class="token" style="color:#fefefe">,</span><span> Y </span><span class="token" style="color:#00e0e0">=</span><span> np</span><span class="token" style="color:#fefefe">.</span><span>meshgrid</span><span class="token" style="color:#fefefe">(</span><span>x</span><span class="token" style="color:#fefefe">,</span><span> y</span><span class="token" style="color:#fefefe">,</span><span> indexing</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#abe338">&#x27;ij&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Convert grids to torch tensors</span><span>
</span><span>X_torch </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>from_numpy</span><span class="token" style="color:#fefefe">(</span><span>X</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#abe338">float</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>Y_torch </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>from_numpy</span><span class="token" style="color:#fefefe">(</span><span>Y</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#abe338">float</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span></code></div></div></pre>
<h2>Initialize Wavefunction</h2>
<pre><div><div style="display:flex;justify-content:space-between;width:100%;background-color:rgb(50, 50, 50);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace;border-top-left-radius:0.3rem;border-top-right-radius:0.3rem;border-bottom-left-radius:0;border-bottom-right-radius:0"><span style="text-decoration:none;color:gray;padding:2px;margin:2px 10px 0 10px">&lt;PYTHON&gt;</span></div><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:0.3rem;border-bottom-right-radius:0.3rem;border:none"><code class="language-python" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#d4d0ab"># Initialize the spinor wavefunction ψ = [ψ_up, ψ_down]^T</span><span>
</span><span></span><span class="token" style="color:#d4d0ab"># Start with a Gaussian wavepacket centered at (x0, y0)</span><span>
</span><span></span><span class="token" style="color:#00e0e0">def</span><span> </span><span class="token" style="color:#ffd700">gaussian_wavepacket</span><span class="token" style="color:#fefefe">(</span><span>x</span><span class="token" style="color:#fefefe">,</span><span> y</span><span class="token" style="color:#fefefe">,</span><span> x0</span><span class="token" style="color:#fefefe">,</span><span> y0</span><span class="token" style="color:#fefefe">,</span><span> sigma_x</span><span class="token" style="color:#fefefe">,</span><span> sigma_y</span><span class="token" style="color:#fefefe">,</span><span> p0</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">:</span><span>
</span><span>    exponent </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">-</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">(</span><span>x </span><span class="token" style="color:#00e0e0">-</span><span> x0</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#00e0e0">**</span><span class="token" style="color:#00e0e0">2</span><span> </span><span class="token" style="color:#00e0e0">/</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">2</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> sigma_x</span><span class="token" style="color:#00e0e0">**</span><span class="token" style="color:#00e0e0">2</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">+</span><span> </span><span class="token" style="color:#fefefe">(</span><span>y </span><span class="token" style="color:#00e0e0">-</span><span> y0</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#00e0e0">**</span><span class="token" style="color:#00e0e0">2</span><span> </span><span class="token" style="color:#00e0e0">/</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">2</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> sigma_y</span><span class="token" style="color:#00e0e0">**</span><span class="token" style="color:#00e0e0">2</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    phase </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">(</span><span>p0</span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">]</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> </span><span class="token" style="color:#fefefe">(</span><span>x </span><span class="token" style="color:#00e0e0">-</span><span> x0</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">+</span><span> p0</span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">]</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> </span><span class="token" style="color:#fefefe">(</span><span>y </span><span class="token" style="color:#00e0e0">-</span><span> y0</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">/</span><span> hbar
</span><span>    envelope </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>exp</span><span class="token" style="color:#fefefe">(</span><span>torch</span><span class="token" style="color:#fefefe">.</span><span>tensor</span><span class="token" style="color:#fefefe">(</span><span>exponent</span><span class="token" style="color:#fefefe">,</span><span> dtype</span><span class="token" style="color:#00e0e0">=</span><span>torch</span><span class="token" style="color:#fefefe">.</span><span>float32</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    phase_factor </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>exp</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">1j</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>tensor</span><span class="token" style="color:#fefefe">(</span><span>phase</span><span class="token" style="color:#fefefe">,</span><span> dtype</span><span class="token" style="color:#00e0e0">=</span><span>torch</span><span class="token" style="color:#fefefe">.</span><span>float32</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">return</span><span> envelope </span><span class="token" style="color:#00e0e0">*</span><span> phase_factor
</span>
<span></span><span class="token" style="color:#d4d0ab"># Initial spinor components (equal superposition)</span><span>
</span><span>psi_up </span><span class="token" style="color:#00e0e0">=</span><span> gaussian_wavepacket</span><span class="token" style="color:#fefefe">(</span><span>X_torch</span><span class="token" style="color:#fefefe">,</span><span> Y_torch</span><span class="token" style="color:#fefefe">,</span><span> x0</span><span class="token" style="color:#fefefe">,</span><span> y0</span><span class="token" style="color:#fefefe">,</span><span> sigma_x</span><span class="token" style="color:#fefefe">,</span><span> sigma_y</span><span class="token" style="color:#fefefe">,</span><span> p0</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">/</span><span> np</span><span class="token" style="color:#fefefe">.</span><span>sqrt</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">2</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>psi_down </span><span class="token" style="color:#00e0e0">=</span><span> gaussian_wavepacket</span><span class="token" style="color:#fefefe">(</span><span>X_torch</span><span class="token" style="color:#fefefe">,</span><span> Y_torch</span><span class="token" style="color:#fefefe">,</span><span> x0</span><span class="token" style="color:#fefefe">,</span><span> y0</span><span class="token" style="color:#fefefe">,</span><span> sigma_x</span><span class="token" style="color:#fefefe">,</span><span> sigma_y</span><span class="token" style="color:#fefefe">,</span><span> p0</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">/</span><span> np</span><span class="token" style="color:#fefefe">.</span><span>sqrt</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">2</span><span class="token" style="color:#fefefe">)</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Combine into a single tensor</span><span>
</span><span>psi </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>stack</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">[</span><span>psi_up</span><span class="token" style="color:#fefefe">,</span><span> psi_down</span><span class="token" style="color:#fefefe">]</span><span class="token" style="color:#fefefe">,</span><span> dim</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#00e0e0">-</span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span>  </span><span class="token" style="color:#d4d0ab"># Shape: (nx, ny, 2)</span></code></div></div></pre>
<h2>Define Operators and Hamiltonian</h2>
<pre><div><div style="display:flex;justify-content:space-between;width:100%;background-color:rgb(50, 50, 50);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace;border-top-left-radius:0.3rem;border-top-right-radius:0.3rem;border-bottom-left-radius:0;border-bottom-right-radius:0"><span style="text-decoration:none;color:gray;padding:2px;margin:2px 10px 0 10px">&lt;PYTHON&gt;</span></div><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:0.3rem;border-bottom-right-radius:0.3rem;border:none"><code class="language-python" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#d4d0ab"># Define the kinetic operator using finite differences</span><span>
</span><span>kx </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>fft</span><span class="token" style="color:#fefefe">.</span><span>fftfreq</span><span class="token" style="color:#fefefe">(</span><span>nx</span><span class="token" style="color:#fefefe">,</span><span> d</span><span class="token" style="color:#00e0e0">=</span><span>dx</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> </span><span class="token" style="color:#00e0e0">2</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> np</span><span class="token" style="color:#fefefe">.</span><span>pi
</span><span>ky </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>fft</span><span class="token" style="color:#fefefe">.</span><span>fftfreq</span><span class="token" style="color:#fefefe">(</span><span>ny</span><span class="token" style="color:#fefefe">,</span><span> d</span><span class="token" style="color:#00e0e0">=</span><span>dy</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> </span><span class="token" style="color:#00e0e0">2</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> np</span><span class="token" style="color:#fefefe">.</span><span>pi
</span><span>KX</span><span class="token" style="color:#fefefe">,</span><span> KY </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>meshgrid</span><span class="token" style="color:#fefefe">(</span><span>kx</span><span class="token" style="color:#fefefe">,</span><span> ky</span><span class="token" style="color:#fefefe">,</span><span> indexing</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#abe338">&#x27;ij&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>K_squared </span><span class="token" style="color:#00e0e0">=</span><span> KX</span><span class="token" style="color:#00e0e0">**</span><span class="token" style="color:#00e0e0">2</span><span> </span><span class="token" style="color:#00e0e0">+</span><span> KY</span><span class="token" style="color:#00e0e0">**</span><span class="token" style="color:#00e0e0">2</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Kinetic energy operator in momentum space</span><span>
</span><span>T_operator </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>exp</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">-</span><span class="token" style="color:#00e0e0">1j</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> hbar </span><span class="token" style="color:#00e0e0">*</span><span> K_squared </span><span class="token" style="color:#00e0e0">*</span><span> dt </span><span class="token" style="color:#00e0e0">/</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">2</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> m_e</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Magnetic field along z with gradient in y</span><span>
</span><span>Bz </span><span class="token" style="color:#00e0e0">=</span><span> B0 </span><span class="token" style="color:#00e0e0">+</span><span> G </span><span class="token" style="color:#00e0e0">*</span><span> </span><span class="token" style="color:#fefefe">(</span><span>Y_torch </span><span class="token" style="color:#00e0e0">-</span><span> y0</span><span class="token" style="color:#fefefe">)</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Pauli matrices</span><span>
</span><span>sigma_z </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>tensor</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">]</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">-</span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">]</span><span class="token" style="color:#fefefe">]</span><span class="token" style="color:#fefefe">,</span><span> dtype</span><span class="token" style="color:#00e0e0">=</span><span>torch</span><span class="token" style="color:#fefefe">.</span><span>cfloat</span><span class="token" style="color:#fefefe">)</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Potential energy operator due to magnetic field</span><span>
</span><span>V </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">-</span><span>mu_B </span><span class="token" style="color:#00e0e0">*</span><span> Bz</span><span class="token" style="color:#fefefe">.</span><span>unsqueeze</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">-</span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">.</span><span>unsqueeze</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">-</span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> sigma_z  </span><span class="token" style="color:#d4d0ab"># Shape: (nx, ny, 2, 2)</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Exponential of the potential energy operator</span><span>
</span><span>V_operator </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>linalg</span><span class="token" style="color:#fefefe">.</span><span>matrix_exp</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">-</span><span class="token" style="color:#00e0e0">1j</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> V </span><span class="token" style="color:#00e0e0">*</span><span> dt </span><span class="token" style="color:#00e0e0">/</span><span> hbar</span><span class="token" style="color:#fefefe">)</span></code></div></div></pre>
<h2>Time Evolution</h2>
<pre><div><div style="display:flex;justify-content:space-between;width:100%;background-color:rgb(50, 50, 50);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace;border-top-left-radius:0.3rem;border-top-right-radius:0.3rem;border-bottom-left-radius:0;border-bottom-right-radius:0"><span style="text-decoration:none;color:gray;padding:2px;margin:2px 10px 0 10px">&lt;PYTHON&gt;</span></div><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:0.3rem;border-bottom-right-radius:0.3rem;border:none"><code class="language-python" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#d4d0ab"># Prepare for time evolution</span><span>
</span><span>probability_densities </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#fefefe">]</span><span>
</span>
<span></span><span class="token" style="color:#00e0e0">for</span><span> t </span><span class="token" style="color:#00e0e0">in</span><span> </span><span class="token" style="color:#abe338">range</span><span class="token" style="color:#fefefe">(</span><span>nt</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">:</span><span>
</span><span>    </span><span class="token" style="color:#d4d0ab"># Apply potential operator (spin-dependent)</span><span>
</span><span>    psi </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>einsum</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;...ab,...b-&gt;...a&#x27;</span><span class="token" style="color:#fefefe">,</span><span> V_operator</span><span class="token" style="color:#fefefe">,</span><span> psi</span><span class="token" style="color:#fefefe">)</span><span>
</span>    
<span>    </span><span class="token" style="color:#d4d0ab"># Fourier transform to momentum space</span><span>
</span><span>    psi_ft </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>fft</span><span class="token" style="color:#fefefe">.</span><span>fft2</span><span class="token" style="color:#fefefe">(</span><span>psi</span><span class="token" style="color:#fefefe">,</span><span> dim</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span>    
<span>    </span><span class="token" style="color:#d4d0ab"># Apply kinetic operator</span><span>
</span><span>    psi_ft</span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">]</span><span> </span><span class="token" style="color:#00e0e0">*=</span><span> T_operator
</span><span>    psi_ft</span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">]</span><span> </span><span class="token" style="color:#00e0e0">*=</span><span> T_operator
</span>    
<span>    </span><span class="token" style="color:#d4d0ab"># Inverse Fourier transform back to position space</span><span>
</span><span>    psi </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>fft</span><span class="token" style="color:#fefefe">.</span><span>ifft2</span><span class="token" style="color:#fefefe">(</span><span>psi_ft</span><span class="token" style="color:#fefefe">,</span><span> dim</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span>    
<span>    </span><span class="token" style="color:#d4d0ab"># Calculate probability density</span><span>
</span><span>    prob_density </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">(</span><span>psi</span><span class="token" style="color:#fefefe">.</span><span>conj</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> psi</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">.</span><span>real</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#abe338">sum</span><span class="token" style="color:#fefefe">(</span><span>dim</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#00e0e0">-</span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span>
</span>    
<span>    </span><span class="token" style="color:#d4d0ab"># Store probability density at intervals</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">if</span><span> t </span><span class="token" style="color:#00e0e0">%</span><span> </span><span class="token" style="color:#00e0e0">50</span><span> </span><span class="token" style="color:#00e0e0">==</span><span> </span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">:</span><span>
</span><span>        probability_densities</span><span class="token" style="color:#fefefe">.</span><span>append</span><span class="token" style="color:#fefefe">(</span><span>prob_density</span><span class="token" style="color:#fefefe">.</span><span>numpy</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span></code></div></div></pre>
<h2>Visualization</h2>
<pre><div><div style="display:flex;justify-content:space-between;width:100%;background-color:rgb(50, 50, 50);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace;border-top-left-radius:0.3rem;border-top-right-radius:0.3rem;border-bottom-left-radius:0;border-bottom-right-radius:0"><span style="text-decoration:none;color:gray;padding:2px;margin:2px 10px 0 10px">&lt;PYTHON&gt;</span></div><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:0.3rem;border-bottom-right-radius:0.3rem;border:none"><code class="language-python" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#d4d0ab"># Plot the probability density at different time intervals</span><span>
</span><span>fig</span><span class="token" style="color:#fefefe">,</span><span> axes </span><span class="token" style="color:#00e0e0">=</span><span> plt</span><span class="token" style="color:#fefefe">.</span><span>subplots</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#abe338">len</span><span class="token" style="color:#fefefe">(</span><span>probability_densities</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">,</span><span> figsize</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">15</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">3</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span>
<span></span><span class="token" style="color:#00e0e0">for</span><span> i</span><span class="token" style="color:#fefefe">,</span><span> density </span><span class="token" style="color:#00e0e0">in</span><span> </span><span class="token" style="color:#abe338">enumerate</span><span class="token" style="color:#fefefe">(</span><span>probability_densities</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">:</span><span>
</span><span>    ax </span><span class="token" style="color:#00e0e0">=</span><span> axes</span><span class="token" style="color:#fefefe">[</span><span>i</span><span class="token" style="color:#fefefe">]</span><span>
</span><span>    im </span><span class="token" style="color:#00e0e0">=</span><span> ax</span><span class="token" style="color:#fefefe">.</span><span>imshow</span><span class="token" style="color:#fefefe">(</span><span>density</span><span class="token" style="color:#fefefe">.</span><span>T</span><span class="token" style="color:#fefefe">,</span><span> extent</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> nx</span><span class="token" style="color:#00e0e0">*</span><span>dx</span><span class="token" style="color:#00e0e0">*</span><span class="token" style="color:#00e0e0">1e9</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> ny</span><span class="token" style="color:#00e0e0">*</span><span>dy</span><span class="token" style="color:#00e0e0">*</span><span class="token" style="color:#00e0e0">1e9</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">,</span><span> origin</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#abe338">&#x27;lower&#x27;</span><span class="token" style="color:#fefefe">,</span><span> cmap</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#abe338">&#x27;viridis&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    ax</span><span class="token" style="color:#fefefe">.</span><span>set_title</span><span class="token" style="color:#fefefe">(</span><span class="token string-interpolation" style="color:#abe338">f&#x27;Time = </span><span class="token string-interpolation interpolation" style="color:#fefefe">{</span><span class="token string-interpolation interpolation">i </span><span class="token string-interpolation interpolation" style="color:#00e0e0">*</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation" style="color:#00e0e0">50</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation" style="color:#00e0e0">*</span><span class="token string-interpolation interpolation"> dt </span><span class="token string-interpolation interpolation" style="color:#00e0e0">*</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation" style="color:#00e0e0">1e15</span><span class="token string-interpolation interpolation" style="color:#fefefe">:</span><span class="token string-interpolation interpolation format-spec">.1f</span><span class="token string-interpolation interpolation" style="color:#fefefe">}</span><span class="token string-interpolation" style="color:#abe338"> fs&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    ax</span><span class="token" style="color:#fefefe">.</span><span>set_xlabel</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;x (nm)&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    ax</span><span class="token" style="color:#fefefe">.</span><span>set_ylabel</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;y (nm)&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    fig</span><span class="token" style="color:#fefefe">.</span><span>colorbar</span><span class="token" style="color:#fefefe">(</span><span>im</span><span class="token" style="color:#fefefe">,</span><span> ax</span><span class="token" style="color:#00e0e0">=</span><span>ax</span><span class="token" style="color:#fefefe">)</span><span>
</span>
<span>plt</span><span class="token" style="color:#fefefe">.</span><span>tight_layout</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>plt</span><span class="token" style="color:#fefefe">.</span><span>show</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span></code></div></div></pre>
<h2>Explanation</h2>
<ul>
<li><strong>Physical Constants</strong>: Defines fundamental constants needed for the simulation.</li>
<li><strong>Simulation Parameters</strong>: Sets up the spatial and temporal resolution, as well as initial conditions.</li>
<li><strong>Spatial Grid</strong>: Creates a 2D grid representing the physical space in which the electron propagates.</li>
<li><strong>Wavefunction Initialization</strong>: Initializes a Gaussian wavepacket representing the electron&#x27;s initial state, equally split between spin-up and spin-down components.</li>
<li><strong>Hamiltonian Operators</strong>:
<ul>
<li><strong>Kinetic Operator</strong>: Uses the Fourier transform method to apply the kinetic energy operator efficiently in momentum space.</li>
<li><strong>Potential Operator</strong>: Incorporates the magnetic field interaction, which depends on position and affects the spin state.</li>
</ul>
</li>
<li><strong>Time Evolution Loop</strong>:
<ul>
<li>Applies the potential operator to account for spin-dependent interactions.</li>
<li>Transforms the wavefunction to momentum space, applies the kinetic operator, and transforms back.</li>
<li>Calculates and stores the probability density at specified intervals.</li>
</ul>
</li>
<li><strong>Visualization</strong>: Plots the probability density snapshots to show the splitting effect due to the magnetic field gradient.</li>
</ul>
<h2>Notes</h2>
<ul>
<li>The simulation uses the <strong>split-operator method</strong>, a common technique for solving the time-dependent Schrödinger equation numerically.</li>
<li><strong>PyTorch</strong> is utilized for tensor operations and automatic differentiation capabilities, although gradients are not explicitly computed here.</li>
<li><strong>Periodic Boundary Conditions</strong> are implicitly assumed due to the use of the Fourier transform. In a real scenario, absorbing boundaries or a larger grid might be necessary to prevent unphysical reflections.</li>
<li>The initial momentum <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">p0</code> gives the electron an initial velocity in the x-direction, allowing it to propagate through the apparatus.</li>
<li>The magnetic field gradient <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">G</code> causes the spin components to experience different forces, leading to spatial separation (splitting) in the y-direction.</li>
</ul>
<h2>Conclusion</h2>
<p>This simulation demonstrates how an electron&#x27;s spinor wavefunction evolves as it passes through a Stern-Gerlach apparatus. The splitting of the probability density illustrates the measurement of spin components due to the magnetic field gradient, a fundamental concept in quantum mechanics.</p>
<p>Feel free to adjust the parameters (such as <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">G</code>, <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">nt</code>, <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">dt</code>, and initial conditions) to explore different regimes and observe how they affect the splitting behavior.</p></div></div>
<div class="mb-4">
<p class="text-green-500 text-lg"><b>USER: </b></p>
<div class="break-words "><p>ok, I think I have this working now. next I want to generate a .gif animation from these successive plots:</p>
<p>for t in range(nt):<br/>
# Apply potential operator (spin-dependent)<br/>
psi = torch.einsum(&#x27;...ab,...b-&gt;...a&#x27;, V_operator, psi)</p>
<pre><div><div style="display:flex;justify-content:space-between;width:100%;background-color:rgb(50, 50, 50);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace;border-top-left-radius:0.3rem;border-top-right-radius:0.3rem;border-bottom-left-radius:0;border-bottom-right-radius:0"><span style="text-decoration:none;color:gray;padding:2px;margin:2px 10px 0 10px">&lt;TEXT&gt;</span></div><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:0.3rem;border-bottom-right-radius:0.3rem;border:none"><code class="language-text" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span># Fourier transform to momentum space
</span>psi_ft = torch.fft.fft2(psi, dim=(0, 1))

# Apply kinetic operator
psi_ft[..., 0] *= T_operator
psi_ft[..., 1] *= T_operator

# Inverse Fourier transform back to position space
psi = torch.fft.ifft2(psi_ft, dim=(0, 1))

# Calculate probability density
prob_density = (psi.conj() * psi).real.sum(dim=-1)

# Store probability density at intervals
if t % 50 == 0:
    # probability_densities.append(prob_density.numpy())
    plt.figure(figsize=(8, 6))
    plt.imshow(prob_density.numpy(),
               extent=(0, nx*dx*1e9, 0, ny*dy*1e9),
               origin=&#x27;lower&#x27;, aspect=&#x27;auto&#x27;, cmap=&#x27;viridis&#x27;)
    plt.xlabel(&#x27;z position (mm)&#x27;)
    plt.ylabel(&#x27;y position (mm)&#x27;)
    plt.title(f&#x27;Time: {t * dt:.2e} s&#x27;)
    # plt.colorbar(label=&#x27;Probability Density&#x27;)
    plt.show()</code></div></div></pre></div></div>
<div class="mb-4">
<p class="text-blue-500 text-lg"><b>ASSISTANT: </b></p>
<div class="break-words "><p>Certainly! Creating a GIF animation of your simulation is a great way to visualize the dynamics over time. You can achieve this by modifying your code to save each frame during the loop and then compile these frames into a GIF using <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">matplotlib</code>&#x27;s animation functions or an external library like <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">imageio</code>.</p>
<p>Below, I&#x27;ll provide two options:</p>
<ol>
<li><strong>Using Matplotlib&#x27;s Animation Module</strong></li>
<li><strong>Using Imageio to Create GIF from Saved Frames</strong></li>
</ol>
<hr/>
<h2>Option 1: Using Matplotlib&#x27;s Animation Module</h2>
<h3>Modify Your Code to Use <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">FuncAnimation</code></h3>
<p>Here&#x27;s how you can modify your code to create an animation using <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">matplotlib.animation.FuncAnimation</code>.</p>
<pre><div><div style="display:flex;justify-content:space-between;width:100%;background-color:rgb(50, 50, 50);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace;border-top-left-radius:0.3rem;border-top-right-radius:0.3rem;border-bottom-left-radius:0;border-bottom-right-radius:0"><span style="text-decoration:none;color:gray;padding:2px;margin:2px 10px 0 10px">&lt;PYTHON&gt;</span></div><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:0.3rem;border-bottom-right-radius:0.3rem;border:none"><code class="language-python" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">import</span><span> numpy </span><span class="token" style="color:#00e0e0">as</span><span> np
</span><span></span><span class="token" style="color:#00e0e0">import</span><span> matplotlib</span><span class="token" style="color:#fefefe">.</span><span>pyplot </span><span class="token" style="color:#00e0e0">as</span><span> plt
</span><span></span><span class="token" style="color:#00e0e0">import</span><span> torch
</span><span></span><span class="token" style="color:#00e0e0">from</span><span> matplotlib</span><span class="token" style="color:#fefefe">.</span><span>animation </span><span class="token" style="color:#00e0e0">import</span><span> FuncAnimation
</span>
<span></span><span class="token" style="color:#d4d0ab"># ... [Your existing code above remains unchanged] ...</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Prepare figure and axis for animation</span><span>
</span><span>fig</span><span class="token" style="color:#fefefe">,</span><span> ax </span><span class="token" style="color:#00e0e0">=</span><span> plt</span><span class="token" style="color:#fefefe">.</span><span>subplots</span><span class="token" style="color:#fefefe">(</span><span>figsize</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">8</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">6</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>extent </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> nx</span><span class="token" style="color:#00e0e0">*</span><span>dx</span><span class="token" style="color:#00e0e0">*</span><span class="token" style="color:#00e0e0">1e9</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> ny</span><span class="token" style="color:#00e0e0">*</span><span>dy</span><span class="token" style="color:#00e0e0">*</span><span class="token" style="color:#00e0e0">1e9</span><span class="token" style="color:#fefefe">)</span><span>  </span><span class="token" style="color:#d4d0ab"># Convert to nm or mm as needed</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Initialize the image with the first frame</span><span>
</span><span>prob_density </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">(</span><span>psi</span><span class="token" style="color:#fefefe">.</span><span>conj</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> psi</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">.</span><span>real</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#abe338">sum</span><span class="token" style="color:#fefefe">(</span><span>dim</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#00e0e0">-</span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>im </span><span class="token" style="color:#00e0e0">=</span><span> ax</span><span class="token" style="color:#fefefe">.</span><span>imshow</span><span class="token" style="color:#fefefe">(</span><span>prob_density</span><span class="token" style="color:#fefefe">.</span><span>numpy</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>               extent</span><span class="token" style="color:#00e0e0">=</span><span>extent</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>               origin</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#abe338">&#x27;lower&#x27;</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>               aspect</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#abe338">&#x27;auto&#x27;</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>               cmap</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#abe338">&#x27;viridis&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>ax</span><span class="token" style="color:#fefefe">.</span><span>set_xlabel</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;z position (nm)&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>ax</span><span class="token" style="color:#fefefe">.</span><span>set_ylabel</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;y position (nm)&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>title </span><span class="token" style="color:#00e0e0">=</span><span> ax</span><span class="token" style="color:#fefefe">.</span><span>set_title</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Function to update each frame</span><span>
</span><span></span><span class="token" style="color:#00e0e0">def</span><span> </span><span class="token" style="color:#ffd700">animate</span><span class="token" style="color:#fefefe">(</span><span>t</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">:</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">global</span><span> psi
</span>
<span>    </span><span class="token" style="color:#00e0e0">for</span><span> _ </span><span class="token" style="color:#00e0e0">in</span><span> </span><span class="token" style="color:#abe338">range</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">50</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">:</span><span>  </span><span class="token" style="color:#d4d0ab"># Update 50 steps per frame</span><span>
</span><span>        </span><span class="token" style="color:#d4d0ab"># Apply potential operator (spin-dependent)</span><span>
</span><span>        psi </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>einsum</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;...ab,...b-&gt;...a&#x27;</span><span class="token" style="color:#fefefe">,</span><span> V_operator</span><span class="token" style="color:#fefefe">,</span><span> psi</span><span class="token" style="color:#fefefe">)</span><span>
</span>        
<span>        </span><span class="token" style="color:#d4d0ab"># Fourier transform to momentum space</span><span>
</span><span>        psi_ft </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>fft</span><span class="token" style="color:#fefefe">.</span><span>fft2</span><span class="token" style="color:#fefefe">(</span><span>psi</span><span class="token" style="color:#fefefe">,</span><span> dim</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span>        
<span>        </span><span class="token" style="color:#d4d0ab"># Apply kinetic operator</span><span>
</span><span>        psi_ft</span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">]</span><span> </span><span class="token" style="color:#00e0e0">*=</span><span> T_operator
</span><span>        psi_ft</span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">]</span><span> </span><span class="token" style="color:#00e0e0">*=</span><span> T_operator
</span>        
<span>        </span><span class="token" style="color:#d4d0ab"># Inverse Fourier transform back to position space</span><span>
</span><span>        psi </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>fft</span><span class="token" style="color:#fefefe">.</span><span>ifft2</span><span class="token" style="color:#fefefe">(</span><span>psi_ft</span><span class="token" style="color:#fefefe">,</span><span> dim</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span>    
<span>    </span><span class="token" style="color:#d4d0ab"># Calculate probability density</span><span>
</span><span>    prob_density </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">(</span><span>psi</span><span class="token" style="color:#fefefe">.</span><span>conj</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> psi</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">.</span><span>real</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#abe338">sum</span><span class="token" style="color:#fefefe">(</span><span>dim</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#00e0e0">-</span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span>
</span>    
<span>    </span><span class="token" style="color:#d4d0ab"># Update image data</span><span>
</span><span>    im</span><span class="token" style="color:#fefefe">.</span><span>set_data</span><span class="token" style="color:#fefefe">(</span><span>prob_density</span><span class="token" style="color:#fefefe">.</span><span>numpy</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    title</span><span class="token" style="color:#fefefe">.</span><span>set_text</span><span class="token" style="color:#fefefe">(</span><span class="token string-interpolation" style="color:#abe338">f&#x27;Time: </span><span class="token string-interpolation interpolation" style="color:#fefefe">{</span><span class="token string-interpolation interpolation">t </span><span class="token string-interpolation interpolation" style="color:#00e0e0">*</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation" style="color:#00e0e0">50</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation" style="color:#00e0e0">*</span><span class="token string-interpolation interpolation"> dt </span><span class="token string-interpolation interpolation" style="color:#00e0e0">*</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation" style="color:#00e0e0">1e15</span><span class="token string-interpolation interpolation" style="color:#fefefe">:</span><span class="token string-interpolation interpolation format-spec">.1f</span><span class="token string-interpolation interpolation" style="color:#fefefe">}</span><span class="token string-interpolation" style="color:#abe338"> fs&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">return</span><span> </span><span class="token" style="color:#fefefe">[</span><span>im</span><span class="token" style="color:#fefefe">,</span><span> title</span><span class="token" style="color:#fefefe">]</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Create the animation</span><span>
</span><span>frames </span><span class="token" style="color:#00e0e0">=</span><span> nt </span><span class="token" style="color:#00e0e0">//</span><span> </span><span class="token" style="color:#00e0e0">50</span><span>  </span><span class="token" style="color:#d4d0ab"># Number of frames</span><span>
</span><span>anim </span><span class="token" style="color:#00e0e0">=</span><span> FuncAnimation</span><span class="token" style="color:#fefefe">(</span><span>fig</span><span class="token" style="color:#fefefe">,</span><span> animate</span><span class="token" style="color:#fefefe">,</span><span> frames</span><span class="token" style="color:#00e0e0">=</span><span>frames</span><span class="token" style="color:#fefefe">,</span><span> interval</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#00e0e0">50</span><span class="token" style="color:#fefefe">,</span><span> blit</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#00e0e0">True</span><span class="token" style="color:#fefefe">)</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Save the animation as a GIF</span><span>
</span><span>anim</span><span class="token" style="color:#fefefe">.</span><span>save</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;stern_gerlach_simulation.gif&#x27;</span><span class="token" style="color:#fefefe">,</span><span> writer</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#abe338">&#x27;imagemagick&#x27;</span><span class="token" style="color:#fefefe">,</span><span> fps</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#00e0e0">10</span><span class="token" style="color:#fefefe">)</span><span>
</span>
<span>plt</span><span class="token" style="color:#fefefe">.</span><span>close</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span></code></div></div></pre>
<h3>Explanation</h3>
<ul>
<li><strong>Initialize the Plot</strong>: Before the loop, set up the figure and axis.</li>
<li><strong>Animate Function</strong>: This function updates the wavefunction <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">psi</code> over 50 time steps and then updates the plot.</li>
<li><strong>FuncAnimation</strong>: This function from <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">matplotlib.animation</code> creates the animation by repeatedly calling <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">animate</code>.</li>
<li><strong>Save the Animation</strong>: The <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">save</code> method saves the animation as a GIF file. Ensure you have <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">ImageMagick</code> installed, or you can use <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">Pillow</code> as the writer.</li>
</ul>
<h3>Requirements</h3>
<ul>
<li>
<p><strong>ImageMagick</strong>: You might need to install ImageMagick for <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">matplotlib</code> to save GIF files.</p>
<pre><div><div style="display:flex;justify-content:space-between;width:100%;background-color:rgb(50, 50, 50);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace;border-top-left-radius:0.3rem;border-top-right-radius:0.3rem;border-bottom-left-radius:0;border-bottom-right-radius:0"><span style="text-decoration:none;color:gray;padding:2px;margin:2px 10px 0 10px">&lt;BASH&gt;</span></div><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:0.3rem;border-bottom-right-radius:0.3rem;border:none"><code class="language-bash" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#d4d0ab"># For Ubuntu/Debian</span><span>
</span><span></span><span class="token" style="color:#ffd700">sudo</span><span> </span><span class="token" style="color:#ffd700">apt-get</span><span> </span><span class="token" style="color:#ffd700">install</span><span> imagemagick</span></code></div></div></pre>
</li>
<li>
<p><strong>Pillow Alternative</strong>: Alternatively, you can use <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">Pillow</code> as the writer:</p>
<pre><div><div style="display:flex;justify-content:space-between;width:100%;background-color:rgb(50, 50, 50);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace;border-top-left-radius:0.3rem;border-top-right-radius:0.3rem;border-bottom-left-radius:0;border-bottom-right-radius:0"><span style="text-decoration:none;color:gray;padding:2px;margin:2px 10px 0 10px">&lt;PYTHON&gt;</span></div><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:0.3rem;border-bottom-right-radius:0.3rem;border:none"><code class="language-python" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>anim</span><span class="token" style="color:#fefefe">.</span><span>save</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;stern_gerlach_simulation.gif&#x27;</span><span class="token" style="color:#fefefe">,</span><span> writer</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#abe338">&#x27;pillow&#x27;</span><span class="token" style="color:#fefefe">,</span><span> fps</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#00e0e0">10</span><span class="token" style="color:#fefefe">)</span></code></div></div></pre>
<p>Ensure you have Pillow installed:</p>
<pre><div><div style="display:flex;justify-content:space-between;width:100%;background-color:rgb(50, 50, 50);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace;border-top-left-radius:0.3rem;border-top-right-radius:0.3rem;border-bottom-left-radius:0;border-bottom-right-radius:0"><span style="text-decoration:none;color:gray;padding:2px;margin:2px 10px 0 10px">&lt;BASH&gt;</span></div><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:0.3rem;border-bottom-right-radius:0.3rem;border:none"><code class="language-bash" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>pip </span><span class="token" style="color:#ffd700">install</span><span> pillow</span></code></div></div></pre>
</li>
</ul>
<hr/>
<h2>Option 2: Using <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">imageio</code></h2>
<p>Alternatively, you can save each frame as an image file and then compile them into a GIF using <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">imageio</code>.</p>
<h3>Install <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">imageio</code></h3>
<p>First, install the <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">imageio</code> library:</p>
<pre><div><div style="display:flex;justify-content:space-between;width:100%;background-color:rgb(50, 50, 50);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace;border-top-left-radius:0.3rem;border-top-right-radius:0.3rem;border-bottom-left-radius:0;border-bottom-right-radius:0"><span style="text-decoration:none;color:gray;padding:2px;margin:2px 10px 0 10px">&lt;BASH&gt;</span></div><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:0.3rem;border-bottom-right-radius:0.3rem;border:none"><code class="language-bash" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>pip </span><span class="token" style="color:#ffd700">install</span><span> imageio</span></code></div></div></pre>
<h3>Modify Your Code to Save Frames</h3>
<pre><div><div style="display:flex;justify-content:space-between;width:100%;background-color:rgb(50, 50, 50);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace;border-top-left-radius:0.3rem;border-top-right-radius:0.3rem;border-bottom-left-radius:0;border-bottom-right-radius:0"><span style="text-decoration:none;color:gray;padding:2px;margin:2px 10px 0 10px">&lt;PYTHON&gt;</span></div><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:0.3rem;border-bottom-right-radius:0.3rem;border:none"><code class="language-python" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">import</span><span> numpy </span><span class="token" style="color:#00e0e0">as</span><span> np
</span><span></span><span class="token" style="color:#00e0e0">import</span><span> matplotlib</span><span class="token" style="color:#fefefe">.</span><span>pyplot </span><span class="token" style="color:#00e0e0">as</span><span> plt
</span><span></span><span class="token" style="color:#00e0e0">import</span><span> torch
</span><span></span><span class="token" style="color:#00e0e0">import</span><span> imageio
</span><span></span><span class="token" style="color:#00e0e0">import</span><span> os
</span>
<span></span><span class="token" style="color:#d4d0ab"># ... [Your existing code above remains unchanged] ...</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Create a directory to save frames</span><span>
</span><span>os</span><span class="token" style="color:#fefefe">.</span><span>makedirs</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;frames&#x27;</span><span class="token" style="color:#fefefe">,</span><span> exist_ok</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#00e0e0">True</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>filenames </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#fefefe">]</span><span>
</span>
<span></span><span class="token" style="color:#00e0e0">for</span><span> t </span><span class="token" style="color:#00e0e0">in</span><span> </span><span class="token" style="color:#abe338">range</span><span class="token" style="color:#fefefe">(</span><span>nt</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">:</span><span>
</span><span>    </span><span class="token" style="color:#d4d0ab"># Apply potential operator (spin-dependent)</span><span>
</span><span>    psi </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>einsum</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;...ab,...b-&gt;...a&#x27;</span><span class="token" style="color:#fefefe">,</span><span> V_operator</span><span class="token" style="color:#fefefe">,</span><span> psi</span><span class="token" style="color:#fefefe">)</span><span>
</span>    
<span>    </span><span class="token" style="color:#d4d0ab"># Fourier transform to momentum space</span><span>
</span><span>    psi_ft </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>fft</span><span class="token" style="color:#fefefe">.</span><span>fft2</span><span class="token" style="color:#fefefe">(</span><span>psi</span><span class="token" style="color:#fefefe">,</span><span> dim</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span>    
<span>    </span><span class="token" style="color:#d4d0ab"># Apply kinetic operator</span><span>
</span><span>    psi_ft</span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">]</span><span> </span><span class="token" style="color:#00e0e0">*=</span><span> T_operator
</span><span>    psi_ft</span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">]</span><span> </span><span class="token" style="color:#00e0e0">*=</span><span> T_operator
</span>    
<span>    </span><span class="token" style="color:#d4d0ab"># Inverse Fourier transform back to position space</span><span>
</span><span>    psi </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>fft</span><span class="token" style="color:#fefefe">.</span><span>ifft2</span><span class="token" style="color:#fefefe">(</span><span>psi_ft</span><span class="token" style="color:#fefefe">,</span><span> dim</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span>    
<span>    </span><span class="token" style="color:#d4d0ab"># Calculate probability density</span><span>
</span><span>    prob_density </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">(</span><span>psi</span><span class="token" style="color:#fefefe">.</span><span>conj</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> psi</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">.</span><span>real</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#abe338">sum</span><span class="token" style="color:#fefefe">(</span><span>dim</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#00e0e0">-</span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span>
</span>    
<span>    </span><span class="token" style="color:#d4d0ab"># Store probability density at intervals</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">if</span><span> t </span><span class="token" style="color:#00e0e0">%</span><span> </span><span class="token" style="color:#00e0e0">10</span><span> </span><span class="token" style="color:#00e0e0">==</span><span> </span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">:</span><span>  </span><span class="token" style="color:#d4d0ab"># Adjust interval as needed</span><span>
</span><span>        plt</span><span class="token" style="color:#fefefe">.</span><span>figure</span><span class="token" style="color:#fefefe">(</span><span>figsize</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">8</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">6</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>        plt</span><span class="token" style="color:#fefefe">.</span><span>imshow</span><span class="token" style="color:#fefefe">(</span><span>prob_density</span><span class="token" style="color:#fefefe">.</span><span>numpy</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>                   extent</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> nx</span><span class="token" style="color:#00e0e0">*</span><span>dx</span><span class="token" style="color:#00e0e0">*</span><span class="token" style="color:#00e0e0">1e9</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> ny</span><span class="token" style="color:#00e0e0">*</span><span>dy</span><span class="token" style="color:#00e0e0">*</span><span class="token" style="color:#00e0e0">1e9</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>                   origin</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#abe338">&#x27;lower&#x27;</span><span class="token" style="color:#fefefe">,</span><span> aspect</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#abe338">&#x27;auto&#x27;</span><span class="token" style="color:#fefefe">,</span><span> cmap</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#abe338">&#x27;viridis&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>        plt</span><span class="token" style="color:#fefefe">.</span><span>xlabel</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;z position (nm)&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>        plt</span><span class="token" style="color:#fefefe">.</span><span>ylabel</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;y position (nm)&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>        plt</span><span class="token" style="color:#fefefe">.</span><span>title</span><span class="token" style="color:#fefefe">(</span><span class="token string-interpolation" style="color:#abe338">f&#x27;Time: </span><span class="token string-interpolation interpolation" style="color:#fefefe">{</span><span class="token string-interpolation interpolation">t </span><span class="token string-interpolation interpolation" style="color:#00e0e0">*</span><span class="token string-interpolation interpolation"> dt </span><span class="token string-interpolation interpolation" style="color:#00e0e0">*</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation" style="color:#00e0e0">1e15</span><span class="token string-interpolation interpolation" style="color:#fefefe">:</span><span class="token string-interpolation interpolation format-spec">.1f</span><span class="token string-interpolation interpolation" style="color:#fefefe">}</span><span class="token string-interpolation" style="color:#abe338"> fs&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>        filename </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token string-interpolation" style="color:#abe338">f&#x27;frames/frame_</span><span class="token string-interpolation interpolation" style="color:#fefefe">{</span><span class="token string-interpolation interpolation">t</span><span class="token string-interpolation interpolation" style="color:#fefefe">:</span><span class="token string-interpolation interpolation format-spec">04d</span><span class="token string-interpolation interpolation" style="color:#fefefe">}</span><span class="token string-interpolation" style="color:#abe338">.png&#x27;</span><span>
</span><span>        filenames</span><span class="token" style="color:#fefefe">.</span><span>append</span><span class="token" style="color:#fefefe">(</span><span>filename</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>        plt</span><span class="token" style="color:#fefefe">.</span><span>savefig</span><span class="token" style="color:#fefefe">(</span><span>filename</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>        plt</span><span class="token" style="color:#fefefe">.</span><span>close</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Compile frames into a GIF</span><span>
</span><span></span><span class="token" style="color:#00e0e0">with</span><span> imageio</span><span class="token" style="color:#fefefe">.</span><span>get_writer</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;stern_gerlach_simulation.gif&#x27;</span><span class="token" style="color:#fefefe">,</span><span> mode</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#abe338">&#x27;I&#x27;</span><span class="token" style="color:#fefefe">,</span><span> fps</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#00e0e0">10</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">as</span><span> writer</span><span class="token" style="color:#fefefe">:</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">for</span><span> filename </span><span class="token" style="color:#00e0e0">in</span><span> filenames</span><span class="token" style="color:#fefefe">:</span><span>
</span><span>        image </span><span class="token" style="color:#00e0e0">=</span><span> imageio</span><span class="token" style="color:#fefefe">.</span><span>imread</span><span class="token" style="color:#fefefe">(</span><span>filename</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>        writer</span><span class="token" style="color:#fefefe">.</span><span>append_data</span><span class="token" style="color:#fefefe">(</span><span>image</span><span class="token" style="color:#fefefe">)</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Optionally, remove frames after creating GIF</span><span>
</span><span></span><span class="token" style="color:#00e0e0">import</span><span> shutil
</span><span>shutil</span><span class="token" style="color:#fefefe">.</span><span>rmtree</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;frames&#x27;</span><span class="token" style="color:#fefefe">)</span></code></div></div></pre>
<h3>Explanation</h3>
<ul>
<li><strong>Create Frames Directory</strong>: Frames are saved in a directory named &#x27;frames&#x27;.</li>
<li><strong>Save Each Frame</strong>: During the simulation loop, every few time steps (adjusted by <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">t % 10</code>), save the plot as an image file.</li>
<li><strong>Collect Filenames</strong>: Store the filenames of the saved frames to use them when creating the GIF.</li>
<li><strong>Create GIF with <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">imageio</code></strong>: After the loop, use <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">imageio</code> to read the saved images and compile them into a GIF.</li>
<li><strong>Cleanup</strong>: Optionally, delete the frames directory after creating the GIF to save space.</li>
</ul>
<h3>Notes</h3>
<ul>
<li><strong>Adjust Frame Rate</strong>: Modify the <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">fps</code> parameter in <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">get_writer</code> to control the speed of the GIF.</li>
<li><strong>Adjust Interval</strong>: Change <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">t % 10</code> to capture frames more or less frequently.</li>
<li><strong>Image Quality</strong>: You can adjust the figure size and DPI in <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">plt.figure</code> and <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">plt.savefig</code> to improve the quality of the images.</li>
</ul>
<hr/>
<h2>Additional Tips</h2>
<ul>
<li>
<p><strong>Colorbar</strong>: If you want to include a colorbar, you can uncomment the <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">plt.colorbar</code> line and adjust the layout accordingly.</p>
</li>
<li>
<p><strong>Position Units</strong>: Ensure consistency in units. Your extent is calculated using <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">nx*dx*1e9</code>, which converts meters to nanometers. Adjust labels if you prefer millimeters.</p>
<pre><div><div style="display:flex;justify-content:space-between;width:100%;background-color:rgb(50, 50, 50);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace;border-top-left-radius:0.3rem;border-top-right-radius:0.3rem;border-bottom-left-radius:0;border-bottom-right-radius:0"><span style="text-decoration:none;color:gray;padding:2px;margin:2px 10px 0 10px">&lt;PYTHON&gt;</span></div><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:0.3rem;border-bottom-right-radius:0.3rem;border:none"><code class="language-python" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>extent </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> nx</span><span class="token" style="color:#00e0e0">*</span><span>dx</span><span class="token" style="color:#00e0e0">*</span><span class="token" style="color:#00e0e0">1e3</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> ny</span><span class="token" style="color:#00e0e0">*</span><span>dy</span><span class="token" style="color:#00e0e0">*</span><span class="token" style="color:#00e0e0">1e3</span><span class="token" style="color:#fefefe">)</span><span>  </span><span class="token" style="color:#d4d0ab"># For mm</span><span>
</span><span>ax</span><span class="token" style="color:#fefefe">.</span><span>set_xlabel</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;z position (mm)&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>ax</span><span class="token" style="color:#fefefe">.</span><span>set_ylabel</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;y position (mm)&#x27;</span><span class="token" style="color:#fefefe">)</span></code></div></div></pre>
</li>
<li>
<p><strong>Animation Libraries</strong>: There are other libraries like <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">celluloid</code> and <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">matplotlib.animation</code> that can be used to create animations. The above methods are straightforward and directly modify your existing code.</p>
</li>
</ul>
<h2>Conclusion</h2>
<p>By modifying your code as shown above, you can generate a GIF animation that visualizes the evolution of the electron&#x27;s probability density as it propagates through the Stern-Gerlach apparatus. This animation will help you and others better understand the dynamics of the simulation.</p>
<p>Feel free to adjust the parameters and styling to suit your preferences. If you encounter any issues or have further questions, don&#x27;t hesitate to ask!</p></div></div>
<div class="mb-4">
<p class="text-green-500 text-lg"><b>USER: </b></p>
<div class="break-words "><p>this all works really well, but I think I need to renormalize each frame because as the wave function spreads out I can no longer see the animation.</p>
<h1>Prepare figure and axis for animation</h1>
<p>fig, ax = plt.subplots(figsize=(8, 6))<br/>
extent = (0, nx<em>dx</em>1e9, 0, ny<em>dy</em>1e9)  # Convert to nm or mm as needed</p>
<h1>Initialize the image with the first frame</h1>
<p>prob_density = (psi.conj() * psi).real.sum(dim=-1)<br/>
im = ax.imshow(prob_density.numpy(),<br/>
extent=extent,<br/>
origin=&#x27;lower&#x27;,<br/>
aspect=&#x27;auto&#x27;,<br/>
cmap=&#x27;viridis&#x27;)<br/>
ax.set_xlabel(&#x27;z position (nm)&#x27;)<br/>
ax.set_ylabel(&#x27;y position (nm)&#x27;)<br/>
title = ax.set_title(&#x27;&#x27;)</p>
<h1>Function to update each frame</h1>
<p>def animate(t):<br/>
global psi</p>
<pre><div><div style="display:flex;justify-content:space-between;width:100%;background-color:rgb(50, 50, 50);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace;border-top-left-radius:0.3rem;border-top-right-radius:0.3rem;border-bottom-left-radius:0;border-bottom-right-radius:0"><span style="text-decoration:none;color:gray;padding:2px;margin:2px 10px 0 10px">&lt;TEXT&gt;</span></div><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:0.3rem;border-bottom-right-radius:0.3rem;border:none"><code class="language-text" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>for _ in range(50):  # Update 50 steps per frame
</span>    # Apply potential operator (spin-dependent)
    psi = torch.einsum(&#x27;...ab,...b-&gt;...a&#x27;, V_operator, psi)
    
    # Fourier transform to momentum space
    psi_ft = torch.fft.fft2(psi, dim=(0, 1))
    
    # Apply kinetic operator
    psi_ft[..., 0] *= T_operator
    psi_ft[..., 1] *= T_operator
    
    # Inverse Fourier transform back to position space
    psi = torch.fft.ifft2(psi_ft, dim=(0, 1))

# Calculate probability density
prob_density = (psi.conj() * psi).real.sum(dim=-1)

# Update image data
im.set_data(prob_density.numpy())
title.set_text(f&#x27;Time: {t * 50 * dt * 1e15:.1f} fs&#x27;)
return [im, title]</code></div></div></pre>
<h1>Create the animation</h1>
<p>frames = nt // 50  # Number of frames<br/>
anim = FuncAnimation(fig, animate, frames=frames, interval=50, blit=True)</p>
<h1>Save the animation as a GIF</h1>
<p>anim.save(&#x27;stern_gerlach_simulation.gif&#x27;, writer=&#x27;imagemagick&#x27;, fps=10)</p>
<p>plt.close()</p></div></div>
<div class="mb-4">
<p class="text-blue-500 text-lg"><b>ASSISTANT: </b></p>
<div class="break-words "><p>You&#x27;re absolutely right—the spreading of the wavefunction causes the peak probability density to decrease over time, making it harder to visualize in the animation. This happens because the wavefunction&#x27;s amplitude spreads over a larger area, leading to lower values in any given point, and when plotted with a fixed color scale based on the initial maximum, later frames appear dim.</p>
<p>To address this, you can <strong>normalize the probability density in each frame</strong> so that the maximum value is consistent across all frames. This way, the highest probability density in each frame maps to the maximum of the color scale, enhancing visibility throughout the animation.</p>
<p>Here&#x27;s how you can modify your code to normalize each frame:</p>
<hr/>
<h3><strong>Modify the <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">animate</code> Function</strong></h3>
<p>Add normalization of <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">prob_density</code> within your <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">animate</code> function:</p>
<pre><div><div style="display:flex;justify-content:space-between;width:100%;background-color:rgb(50, 50, 50);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace;border-top-left-radius:0.3rem;border-top-right-radius:0.3rem;border-bottom-left-radius:0;border-bottom-right-radius:0"><span style="text-decoration:none;color:gray;padding:2px;margin:2px 10px 0 10px">&lt;PYTHON&gt;</span></div><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:0.3rem;border-bottom-right-radius:0.3rem;border:none"><code class="language-python" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">def</span><span> </span><span class="token" style="color:#ffd700">animate</span><span class="token" style="color:#fefefe">(</span><span>t</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">:</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">global</span><span> psi
</span>
<span>    </span><span class="token" style="color:#00e0e0">for</span><span> _ </span><span class="token" style="color:#00e0e0">in</span><span> </span><span class="token" style="color:#abe338">range</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">50</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">:</span><span>  </span><span class="token" style="color:#d4d0ab"># Update 50 steps per frame</span><span>
</span><span>        </span><span class="token" style="color:#d4d0ab"># Apply potential operator (spin-dependent)</span><span>
</span><span>        psi </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>einsum</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;...ab,...b-&gt;...a&#x27;</span><span class="token" style="color:#fefefe">,</span><span> V_operator</span><span class="token" style="color:#fefefe">,</span><span> psi</span><span class="token" style="color:#fefefe">)</span><span>
</span>        
<span>        </span><span class="token" style="color:#d4d0ab"># Fourier transform to momentum space</span><span>
</span><span>        psi_ft </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>fft</span><span class="token" style="color:#fefefe">.</span><span>fft2</span><span class="token" style="color:#fefefe">(</span><span>psi</span><span class="token" style="color:#fefefe">,</span><span> dim</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span>        
<span>        </span><span class="token" style="color:#d4d0ab"># Apply kinetic operator</span><span>
</span><span>        psi_ft</span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">]</span><span> </span><span class="token" style="color:#00e0e0">*=</span><span> T_operator
</span><span>        psi_ft</span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">]</span><span> </span><span class="token" style="color:#00e0e0">*=</span><span> T_operator
</span>        
<span>        </span><span class="token" style="color:#d4d0ab"># Inverse Fourier transform back to position space</span><span>
</span><span>        psi </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>fft</span><span class="token" style="color:#fefefe">.</span><span>ifft2</span><span class="token" style="color:#fefefe">(</span><span>psi_ft</span><span class="token" style="color:#fefefe">,</span><span> dim</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span>    
<span>    </span><span class="token" style="color:#d4d0ab"># Calculate probability density</span><span>
</span><span>    prob_density </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">(</span><span>psi</span><span class="token" style="color:#fefefe">.</span><span>conj</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> psi</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">.</span><span>real</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#abe338">sum</span><span class="token" style="color:#fefefe">(</span><span>dim</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#00e0e0">-</span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span>
</span>    
<span>    </span><span class="token" style="color:#d4d0ab"># Normalize the probability density</span><span>
</span><span>    prob_density </span><span class="token" style="color:#00e0e0">/=</span><span> prob_density</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#abe338">max</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">+</span><span> </span><span class="token" style="color:#00e0e0">1e-16</span><span>  </span><span class="token" style="color:#d4d0ab"># Add small number to prevent division by zero</span><span>
</span>    
<span>    </span><span class="token" style="color:#d4d0ab"># Update image data</span><span>
</span><span>    im</span><span class="token" style="color:#fefefe">.</span><span>set_data</span><span class="token" style="color:#fefefe">(</span><span>prob_density</span><span class="token" style="color:#fefefe">.</span><span>numpy</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    im</span><span class="token" style="color:#fefefe">.</span><span>set_clim</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span>  </span><span class="token" style="color:#d4d0ab"># Update color scale to match normalization</span><span>
</span><span>    title</span><span class="token" style="color:#fefefe">.</span><span>set_text</span><span class="token" style="color:#fefefe">(</span><span class="token string-interpolation" style="color:#abe338">f&#x27;Time: </span><span class="token string-interpolation interpolation" style="color:#fefefe">{</span><span class="token string-interpolation interpolation">t </span><span class="token string-interpolation interpolation" style="color:#00e0e0">*</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation" style="color:#00e0e0">50</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation" style="color:#00e0e0">*</span><span class="token string-interpolation interpolation"> dt </span><span class="token string-interpolation interpolation" style="color:#00e0e0">*</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation" style="color:#00e0e0">1e15</span><span class="token string-interpolation interpolation" style="color:#fefefe">:</span><span class="token string-interpolation interpolation format-spec">.1f</span><span class="token string-interpolation interpolation" style="color:#fefefe">}</span><span class="token string-interpolation" style="color:#abe338"> fs&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">return</span><span> </span><span class="token" style="color:#fefefe">[</span><span>im</span><span class="token" style="color:#fefefe">,</span><span> title</span><span class="token" style="color:#fefefe">]</span></code></div></div></pre>
<p><strong>Explanation:</strong></p>
<ul>
<li><strong>Normalization</strong>: We divide <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">prob_density</code> by its maximum value in each frame. The <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">+ 1e-16</code> ensures numerical stability by preventing division by zero in case <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">prob_density.max()</code> is zero.</li>
<li><strong>Update Color Scale</strong>: After normalizing, we update the color limits using <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">im.set_clim(0, 1)</code> to ensure the color mapping corresponds to the normalized data.</li>
<li><strong>Consistent Scaling</strong>: This approach maintains consistent visual scaling between frames, making the animation clearer.</li>
</ul>
<hr/>
<h3><strong>Alternative: Use Logarithmic Color Scale</strong></h3>
<p>If you prefer not to normalize each frame (to preserve relative amplitude information), you can use a logarithmic color scale, which enhances features across a wide range of values.</p>
<h4><strong>Modify the <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">imshow</code> Call with <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">norm=LogNorm</code></strong></h4>
<p>First, import <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">LogNorm</code>:</p>
<pre><div><div style="display:flex;justify-content:space-between;width:100%;background-color:rgb(50, 50, 50);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace;border-top-left-radius:0.3rem;border-top-right-radius:0.3rem;border-bottom-left-radius:0;border-bottom-right-radius:0"><span style="text-decoration:none;color:gray;padding:2px;margin:2px 10px 0 10px">&lt;PYTHON&gt;</span></div><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:0.3rem;border-bottom-right-radius:0.3rem;border:none"><code class="language-python" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">from</span><span> matplotlib</span><span class="token" style="color:#fefefe">.</span><span>colors </span><span class="token" style="color:#00e0e0">import</span><span> LogNorm</span></code></div></div></pre>
<p>Then, when initializing <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">im</code>, use:</p>
<pre><div><div style="display:flex;justify-content:space-between;width:100%;background-color:rgb(50, 50, 50);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace;border-top-left-radius:0.3rem;border-top-right-radius:0.3rem;border-bottom-left-radius:0;border-bottom-right-radius:0"><span style="text-decoration:none;color:gray;padding:2px;margin:2px 10px 0 10px">&lt;PYTHON&gt;</span></div><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:0.3rem;border-bottom-right-radius:0.3rem;border:none"><code class="language-python" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>im </span><span class="token" style="color:#00e0e0">=</span><span> ax</span><span class="token" style="color:#fefefe">.</span><span>imshow</span><span class="token" style="color:#fefefe">(</span><span>prob_density</span><span class="token" style="color:#fefefe">.</span><span>numpy</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>               extent</span><span class="token" style="color:#00e0e0">=</span><span>extent</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>               origin</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#abe338">&#x27;lower&#x27;</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>               aspect</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#abe338">&#x27;auto&#x27;</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>               cmap</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#abe338">&#x27;viridis&#x27;</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>               norm</span><span class="token" style="color:#00e0e0">=</span><span>LogNorm</span><span class="token" style="color:#fefefe">(</span><span>vmin</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#00e0e0">1e-16</span><span class="token" style="color:#fefefe">,</span><span> vmax</span><span class="token" style="color:#00e0e0">=</span><span>prob_density</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#abe338">max</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span></code></div></div></pre>
<p><strong>Note:</strong></p>
<ul>
<li><strong>Set <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">vmin</code></strong>: We set <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">vmin</code> to a small positive number (<code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">1e-16</code>) to avoid issues with log of zero.</li>
<li><strong>Set <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">vmax</code></strong>: Use the maximum of <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">prob_density</code> from the initial frame or compute it over all frames.</li>
</ul>
<h4><strong>Update the Color Scale in <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">animate</code> Function</strong></h4>
<p>Within the <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">animate</code> function, after updating <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">prob_density</code>, update the color limits if necessary:</p>
<pre><div><div style="display:flex;justify-content:space-between;width:100%;background-color:rgb(50, 50, 50);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace;border-top-left-radius:0.3rem;border-top-right-radius:0.3rem;border-bottom-left-radius:0;border-bottom-right-radius:0"><span style="text-decoration:none;color:gray;padding:2px;margin:2px 10px 0 10px">&lt;PYTHON&gt;</span></div><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:0.3rem;border-bottom-right-radius:0.3rem;border:none"><code class="language-python" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">def</span><span> </span><span class="token" style="color:#ffd700">animate</span><span class="token" style="color:#fefefe">(</span><span>t</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">:</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">global</span><span> psi
</span>
<span>    </span><span class="token" style="color:#00e0e0">for</span><span> _ </span><span class="token" style="color:#00e0e0">in</span><span> </span><span class="token" style="color:#abe338">range</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">50</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">:</span><span>  </span><span class="token" style="color:#d4d0ab"># Update 50 steps per frame</span><span>
</span><span>        </span><span class="token" style="color:#d4d0ab"># [Time evolution steps remain the same]</span><span>
</span>
<span>    </span><span class="token" style="color:#d4d0ab"># Calculate probability density</span><span>
</span><span>    prob_density </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">(</span><span>psi</span><span class="token" style="color:#fefefe">.</span><span>conj</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> psi</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">.</span><span>real</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#abe338">sum</span><span class="token" style="color:#fefefe">(</span><span>dim</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#00e0e0">-</span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span>
</span>    
<span>    </span><span class="token" style="color:#d4d0ab"># Update image data</span><span>
</span><span>    im</span><span class="token" style="color:#fefefe">.</span><span>set_data</span><span class="token" style="color:#fefefe">(</span><span>prob_density</span><span class="token" style="color:#fefefe">.</span><span>numpy</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span>    
<span>    </span><span class="token" style="color:#d4d0ab"># Optionally update color limits if the maximum changes significantly</span><span>
</span><span>    im</span><span class="token" style="color:#fefefe">.</span><span>set_clim</span><span class="token" style="color:#fefefe">(</span><span>vmin</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#00e0e0">1e-16</span><span class="token" style="color:#fefefe">,</span><span> vmax</span><span class="token" style="color:#00e0e0">=</span><span>prob_density</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#abe338">max</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span>    
<span>    title</span><span class="token" style="color:#fefefe">.</span><span>set_text</span><span class="token" style="color:#fefefe">(</span><span class="token string-interpolation" style="color:#abe338">f&#x27;Time: </span><span class="token string-interpolation interpolation" style="color:#fefefe">{</span><span class="token string-interpolation interpolation">t </span><span class="token string-interpolation interpolation" style="color:#00e0e0">*</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation" style="color:#00e0e0">50</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation" style="color:#00e0e0">*</span><span class="token string-interpolation interpolation"> dt </span><span class="token string-interpolation interpolation" style="color:#00e0e0">*</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation" style="color:#00e0e0">1e15</span><span class="token string-interpolation interpolation" style="color:#fefefe">:</span><span class="token string-interpolation interpolation format-spec">.1f</span><span class="token string-interpolation interpolation" style="color:#fefefe">}</span><span class="token string-interpolation" style="color:#abe338"> fs&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">return</span><span> </span><span class="token" style="color:#fefefe">[</span><span>im</span><span class="token" style="color:#fefefe">,</span><span> title</span><span class="token" style="color:#fefefe">]</span></code></div></div></pre>
<p><strong>Explanation:</strong></p>
<ul>
<li><strong>Log Scale</strong>: Using <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">LogNorm</code> scales the colormap logarithmically, enhancing low-magnitude features.</li>
<li><strong>Update <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">vmax</code></strong>: If you expect <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">prob_density.max()</code> to decrease significantly over time, you might need to update <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">vmax</code> to maintain contrast.</li>
<li><strong>Potential Flickering</strong>: Be aware that changing <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">vmax</code> may cause flickering in the animation due to shifting color scales.</li>
</ul>
<hr/>
<h3><strong>Which Method to Choose?</strong></h3>
<ul>
<li>
<p><strong>Normalization per Frame</strong>: Best for visual clarity if you&#x27;re primarily interested in observing qualitative changes in the probability density distribution over time.</p>
<ul>
<li><strong>Pros</strong>: Consistent maximum value, improved visibility.</li>
<li><strong>Cons</strong>: Relative amplitude information between frames is lost.</li>
</ul>
</li>
<li>
<p><strong>Logarithmic Scale</strong>: Preserves relative amplitude information, useful if you want to perceive both high and low probability regions simultaneously.</p>
<ul>
<li><strong>Pros</strong>: Retains amplitude relationships, enhances visibility across magnitudes.</li>
<li><strong>Cons</strong>: Low values might still be less visible, potential for flickering.</li>
</ul>
</li>
</ul>
<hr/>
<h3><strong>Complete Modified Code Using Normalization</strong></h3>
<p>Here&#x27;s how your code would look with the normalization approach applied:</p>
<pre><div><div style="display:flex;justify-content:space-between;width:100%;background-color:rgb(50, 50, 50);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, &quot;Liberation Mono&quot;, &quot;Courier New&quot;, monospace;border-top-left-radius:0.3rem;border-top-right-radius:0.3rem;border-bottom-left-radius:0;border-bottom-right-radius:0"><span style="text-decoration:none;color:gray;padding:2px;margin:2px 10px 0 10px">&lt;PYTHON&gt;</span></div><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:0.3rem;border-bottom-right-radius:0.3rem;border:none"><code class="language-python" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">import</span><span> numpy </span><span class="token" style="color:#00e0e0">as</span><span> np
</span><span></span><span class="token" style="color:#00e0e0">import</span><span> matplotlib</span><span class="token" style="color:#fefefe">.</span><span>pyplot </span><span class="token" style="color:#00e0e0">as</span><span> plt
</span><span></span><span class="token" style="color:#00e0e0">import</span><span> torch
</span><span></span><span class="token" style="color:#00e0e0">from</span><span> matplotlib</span><span class="token" style="color:#fefefe">.</span><span>animation </span><span class="token" style="color:#00e0e0">import</span><span> FuncAnimation
</span>
<span></span><span class="token" style="color:#d4d0ab"># ... [Your existing code for constants, grid setup, and initialization remains unchanged] ...</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Prepare figure and axis for animation</span><span>
</span><span>fig</span><span class="token" style="color:#fefefe">,</span><span> ax </span><span class="token" style="color:#00e0e0">=</span><span> plt</span><span class="token" style="color:#fefefe">.</span><span>subplots</span><span class="token" style="color:#fefefe">(</span><span>figsize</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">8</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">6</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>extent </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> nx</span><span class="token" style="color:#00e0e0">*</span><span>dx</span><span class="token" style="color:#00e0e0">*</span><span class="token" style="color:#00e0e0">1e9</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> ny</span><span class="token" style="color:#00e0e0">*</span><span>dy</span><span class="token" style="color:#00e0e0">*</span><span class="token" style="color:#00e0e0">1e9</span><span class="token" style="color:#fefefe">)</span><span>  </span><span class="token" style="color:#d4d0ab"># Convert to nm or mm as needed</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Initialize the image with the first frame</span><span>
</span><span>prob_density </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">(</span><span>psi</span><span class="token" style="color:#fefefe">.</span><span>conj</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> psi</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">.</span><span>real</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#abe338">sum</span><span class="token" style="color:#fefefe">(</span><span>dim</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#00e0e0">-</span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>prob_density </span><span class="token" style="color:#00e0e0">/=</span><span> prob_density</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#abe338">max</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">+</span><span> </span><span class="token" style="color:#00e0e0">1e-16</span><span>  </span><span class="token" style="color:#d4d0ab"># Normalize</span><span>
</span><span>im </span><span class="token" style="color:#00e0e0">=</span><span> ax</span><span class="token" style="color:#fefefe">.</span><span>imshow</span><span class="token" style="color:#fefefe">(</span><span>prob_density</span><span class="token" style="color:#fefefe">.</span><span>numpy</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>               extent</span><span class="token" style="color:#00e0e0">=</span><span>extent</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>               origin</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#abe338">&#x27;lower&#x27;</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>               aspect</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#abe338">&#x27;auto&#x27;</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>               cmap</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#abe338">&#x27;viridis&#x27;</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>               vmin</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> vmax</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span>  </span><span class="token" style="color:#d4d0ab"># Set color limits</span><span>
</span><span>ax</span><span class="token" style="color:#fefefe">.</span><span>set_xlabel</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;z position (nm)&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>ax</span><span class="token" style="color:#fefefe">.</span><span>set_ylabel</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;y position (nm)&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>title </span><span class="token" style="color:#00e0e0">=</span><span> ax</span><span class="token" style="color:#fefefe">.</span><span>set_title</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Function to update each frame</span><span>
</span><span></span><span class="token" style="color:#00e0e0">def</span><span> </span><span class="token" style="color:#ffd700">animate</span><span class="token" style="color:#fefefe">(</span><span>t</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">:</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">global</span><span> psi
</span>
<span>    </span><span class="token" style="color:#00e0e0">for</span><span> _ </span><span class="token" style="color:#00e0e0">in</span><span> </span><span class="token" style="color:#abe338">range</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">50</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">:</span><span>  </span><span class="token" style="color:#d4d0ab"># Update 50 steps per frame</span><span>
</span><span>        </span><span class="token" style="color:#d4d0ab"># Apply potential operator (spin-dependent)</span><span>
</span><span>        psi </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>einsum</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;...ab,...b-&gt;...a&#x27;</span><span class="token" style="color:#fefefe">,</span><span> V_operator</span><span class="token" style="color:#fefefe">,</span><span> psi</span><span class="token" style="color:#fefefe">)</span><span>
</span>        
<span>        </span><span class="token" style="color:#d4d0ab"># Fourier transform to momentum space</span><span>
</span><span>        psi_ft </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>fft</span><span class="token" style="color:#fefefe">.</span><span>fft2</span><span class="token" style="color:#fefefe">(</span><span>psi</span><span class="token" style="color:#fefefe">,</span><span> dim</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span>        
<span>        </span><span class="token" style="color:#d4d0ab"># Apply kinetic operator</span><span>
</span><span>        psi_ft</span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">]</span><span> </span><span class="token" style="color:#00e0e0">*=</span><span> T_operator
</span><span>        psi_ft</span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">]</span><span> </span><span class="token" style="color:#00e0e0">*=</span><span> T_operator
</span>        
<span>        </span><span class="token" style="color:#d4d0ab"># Inverse Fourier transform back to position space</span><span>
</span><span>        psi </span><span class="token" style="color:#00e0e0">=</span><span> torch</span><span class="token" style="color:#fefefe">.</span><span>fft</span><span class="token" style="color:#fefefe">.</span><span>ifft2</span><span class="token" style="color:#fefefe">(</span><span>psi_ft</span><span class="token" style="color:#fefefe">,</span><span> dim</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span>    
<span>    </span><span class="token" style="color:#d4d0ab"># Calculate probability density</span><span>
</span><span>    prob_density </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">(</span><span>psi</span><span class="token" style="color:#fefefe">.</span><span>conj</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> psi</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">.</span><span>real</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#abe338">sum</span><span class="token" style="color:#fefefe">(</span><span>dim</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#00e0e0">-</span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span>
</span>    
<span>    </span><span class="token" style="color:#d4d0ab"># Normalize the probability density</span><span>
</span><span>    prob_density </span><span class="token" style="color:#00e0e0">/=</span><span> prob_density</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#abe338">max</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">+</span><span> </span><span class="token" style="color:#00e0e0">1e-16</span><span>  </span><span class="token" style="color:#d4d0ab"># Add small number to prevent division by zero</span><span>
</span>    
<span>    </span><span class="token" style="color:#d4d0ab"># Update image data</span><span>
</span><span>    im</span><span class="token" style="color:#fefefe">.</span><span>set_data</span><span class="token" style="color:#fefefe">(</span><span>prob_density</span><span class="token" style="color:#fefefe">.</span><span>numpy</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#d4d0ab"># Color limits are already set to [0, 1], no need to update clim</span><span>
</span><span>    title</span><span class="token" style="color:#fefefe">.</span><span>set_text</span><span class="token" style="color:#fefefe">(</span><span class="token string-interpolation" style="color:#abe338">f&#x27;Time: </span><span class="token string-interpolation interpolation" style="color:#fefefe">{</span><span class="token string-interpolation interpolation">t </span><span class="token string-interpolation interpolation" style="color:#00e0e0">*</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation" style="color:#00e0e0">50</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation" style="color:#00e0e0">*</span><span class="token string-interpolation interpolation"> dt </span><span class="token string-interpolation interpolation" style="color:#00e0e0">*</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation" style="color:#00e0e0">1e15</span><span class="token string-interpolation interpolation" style="color:#fefefe">:</span><span class="token string-interpolation interpolation format-spec">.1f</span><span class="token string-interpolation interpolation" style="color:#fefefe">}</span><span class="token string-interpolation" style="color:#abe338"> fs&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">return</span><span> </span><span class="token" style="color:#fefefe">[</span><span>im</span><span class="token" style="color:#fefefe">,</span><span> title</span><span class="token" style="color:#fefefe">]</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Create the animation</span><span>
</span><span>frames </span><span class="token" style="color:#00e0e0">=</span><span> nt </span><span class="token" style="color:#00e0e0">//</span><span> </span><span class="token" style="color:#00e0e0">50</span><span>  </span><span class="token" style="color:#d4d0ab"># Number of frames</span><span>
</span><span>anim </span><span class="token" style="color:#00e0e0">=</span><span> FuncAnimation</span><span class="token" style="color:#fefefe">(</span><span>fig</span><span class="token" style="color:#fefefe">,</span><span> animate</span><span class="token" style="color:#fefefe">,</span><span> frames</span><span class="token" style="color:#00e0e0">=</span><span>frames</span><span class="token" style="color:#fefefe">,</span><span> interval</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#00e0e0">50</span><span class="token" style="color:#fefefe">,</span><span> blit</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#00e0e0">True</span><span class="token" style="color:#fefefe">)</span><span>
</span>
<span></span><span class="token" style="color:#d4d0ab"># Save the animation as a GIF</span><span>
</span><span>anim</span><span class="token" style="color:#fefefe">.</span><span>save</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;stern_gerlach_simulation.gif&#x27;</span><span class="token" style="color:#fefefe">,</span><span> writer</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#abe338">&#x27;pillow&#x27;</span><span class="token" style="color:#fefefe">,</span><span> fps</span><span class="token" style="color:#00e0e0">=</span><span class="token" style="color:#00e0e0">10</span><span class="token" style="color:#fefefe">)</span><span>
</span>
<span>plt</span><span class="token" style="color:#fefefe">.</span><span>close</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span></code></div></div></pre>
<p><strong>Notes:</strong></p>
<ul>
<li><strong>Set <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">vmin</code> and <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">vmax</code></strong>: When initializing <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">im</code>, we set <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">vmin=0</code> and <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">vmax=1</code> to match the normalization.</li>
<li><strong>No Need to Update <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">clim</code></strong>: Since the color limits are consistent, you don&#x27;t need to update them in each frame.</li>
<li><strong>Writer Update</strong>: Changed <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">writer</code> to <code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">&#x27;pillow&#x27;</code> for broader compatibility. Ensure you have Pillow installed (<code style="background-color:#f1f1f1;padding:2px 4px;marigin:0 4px;border-radius:4px;border:1px solid;border-color:#ddd">pip install pillow</code>).</li>
</ul>
<hr/>
<h3><strong>Potential Drawbacks and Considerations</strong></h3>
<ul>
<li><strong>Loss of Absolute Amplitude Information</strong>: Normalizing each frame hides changes in the total amplitude of the probability density. In quantum mechanics, the total probability should remain constant (assuming a closed system), so the amplitude changes are due to spreading rather than loss or gain of total probability.</li>
<li><strong>Visual Artifacts</strong>: Rapid changes in the wavefunction&#x27;s shape can still cause visual artifacts or apparent flickering, even with normalization.</li>
<li><strong>Interpretation of Color Scale</strong>: With normalization, the color scale represents relative probability density within each frame, not absolute values across frames.</li>
</ul>
<hr/>
<h3><strong>Final Thoughts</strong></h3>
<p>By normalizing each frame, you&#x27;ll maintain a consistent and clear visualization of the probability density throughout the animation. This will help you and others observe the dynamics of the wavefunction as it propagates through the Stern-Gerlach apparatus without the display becoming too dim.</p>
<p>Feel free to experiment with both the normalization and logarithmic scaling methods to see which provides the best visual representation for your purposes. If you have any further questions or need additional assistance, don&#x27;t hesitate to ask!</p></div></div>
<hr />
</div>

        <hr />
        <a href="https://chatboxai.app" style="display: flex; align-items: center;" class="text-sky-500" target="_blank">
            <img src='https://chatboxai.app/icon.png' class="w-12 pr-2">
            <b style='font-size:30px'>Chatbox AI</b>
        </a>
        <p><a a href="https://chatboxai.app" target="_blank">https://chatboxai.app</a></p>
    </div>
</body>
</html>
